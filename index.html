<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iceland Trip - V71 Perfect Center</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Montserrat', 'Noto Sans TC', system-ui, sans-serif; background-color: #F8FAFC; color: #334155; margin: 0; padding: 0; }
        [v-cloak] { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Map Styles */
        #map-full { height: calc(100vh - 240px); width: 100%; border-radius: 1rem; z-index: 1; }
        
        /* Header & UI */
        .header-refined-bg {
            background-color: #F8FAFC; 
            background-image: linear-gradient(to bottom, #ffffff 0%, #F1F5F9 100%);
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 10px 30px -10px rgba(15, 76, 117, 0.1); 
            z-index: 50;
            position: relative;
        }
        .header-glow {
            position: absolute;
            top: -20%;
            right: -10%;
            width: 70%;
            height: 100%;
            background: radial-gradient(circle, rgba(50, 130, 184, 0.08) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        .fade-mask-left { position: absolute; left: 0; top: 0; bottom: 0; width: 24px; background: linear-gradient(to right, #F8FAFC 20%, transparent); z-index: 20; pointer-events: none; }
        .fade-mask-right { position: absolute; right: 0; top: 0; bottom: 0; width: 24px; background: linear-gradient(to left, #F8FAFC 20%, transparent); z-index: 20; pointer-events: none; }

        .bg-aurora { background: linear-gradient(135deg, #0f4c75 0%, #3282b8 50%, #00b894 100%); }
        /* Exact Dark Blue */
        .bg-card-custom { background-color: #0B1D35; } 
        
        .modal-input { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.8rem; padding: 0.8rem; width: 100%; outline: none; font-weight: 600; transition: all 0.2s; }
        .modal-input:focus { border-color: #3282b8; background-color: #fff; }
        .ratio-16-9 { width: 100%; aspect-ratio: 16 / 9; object-fit: cover; background-color: #e2e8f0; }
        
        .tab-active { color: #0f4c75; }
        .tab-inactive { color: #94a3b8; }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        
        /* Flight Path Animation */
        .flight-path {
            stroke-dasharray: 4;
            animation: dash 60s linear infinite;
        }
        @keyframes dash {
            to { stroke-dashoffset: -100; }
        }
        
        /* Ticket Notch Effect */
        .ticket-notch-l, .ticket-notch-r {
            position: absolute;
            top: 50%;
            width: 24px;
            height: 24px;
            background-color: #F8FAFC; /* Match body bg */
            border-radius: 50%;
            transform: translateY(-50%);
            z-index: 20;
        }
        .ticket-notch-l { left: -12px; }
        .ticket-notch-r { right: -12px; }
        
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); }
    </style>
</head>
<body class="bg-[#F8FAFC]">

<div id="app" class="w-full max-w-md mx-auto min-h-screen flex flex-col relative pb-24" v-cloak>

    <!-- 1. HEADER -->
    <div class="sticky top-0 z-40 header-refined-bg pt-6 px-0 relative pb-0 overflow-hidden">
        <div class="header-glow"></div>
        
        <!-- Top Bar -->
        <div class="flex justify-between items-center mb-2 px-6 relative z-10">
            <button @click="openShareModal" class="w-10 h-10 rounded-2xl bg-white/80 flex items-center justify-center text-[#3282b8] hover:bg-white transition-all active:scale-95 shadow-sm border border-slate-100">
                <i class="fa-solid fa-share-nodes"></i>
            </button>
            
            <div class="flex flex-col items-center">
                <div class="text-[10px] font-bold tracking-[0.2em] text-slate-400 uppercase mb-1 drop-shadow-sm">Iceland Trip</div>
                <div class="bg-gradient-to-r from-[#0f4c75] to-[#3282b8] px-4 py-1.5 rounded-full shadow-lg shadow-blue-900/10">
                    <h1 class="text-center font-bold text-xs text-white tracking-wider flex items-center gap-2">
                        <i class="fa-regular fa-snowflake fa-spin-pulse" style="--fa-animation-duration: 3s;"></i>
                        2026-03 ÂÜ∞Â≥∂Ê•µÂÖâËá™ÈßïÈÅä
                        <i class="fa-regular fa-snowflake fa-spin-pulse" style="--fa-animation-duration: 4s;"></i>
                    </h1>
                </div>
            </div>
            <div class="w-10"></div>
        </div>

        <!-- Date Selector -->
        <div v-show="currentTab === 'itinerary' || currentTab === 'map'" class="relative z-10 animate-slide-up">
            <div class="fade-mask-left"></div>
            <div class="fade-mask-right"></div>
            <div class="flex overflow-x-auto gap-3 pl-6 pr-6 pt-2 pb-0 no-scrollbar snap-x cursor-grab active:cursor-grabbing items-center relative z-10">
                <button v-for="d in totalDays" :key="d" @click="currentDay = d"
                        class="flex flex-col items-center justify-center transition-all duration-200 flex-shrink-0 w-[68px] py-3 rounded-2xl border snap-center group relative mb-4 bg-white shadow-sm" 
                        :class="currentDay === d ? 'bg-[#0f4c75] !text-white !border-[#0f4c75] shadow-xl shadow-blue-900/40 ring-1 ring-[#0f4c75]/20' : 'text-slate-400 border-slate-100 hover:bg-white hover:border-slate-200 hover:shadow-md'">
                    <span class="text-[9px] font-bold uppercase tracking-wider opacity-70">Day {{ d }}</span>
                    <div class="w-1 h-1 rounded-full my-1.5 transition-all" :class="currentDay === d ? 'bg-[#00b894] w-4' : 'bg-slate-300'"></div>
                    <div class="flex flex-col items-center leading-none gap-0.5">
                        <span class="text-[13px] font-bold font-mono">{{ getDateString(d).date }}</span>
                        <span class="text-[10px] font-bold opacity-80 font-mono tracking-wider">{{ getDateString(d).day }}</span>
                    </div>
                </button>
                <button @click="addDay" class="flex-shrink-0 w-12 h-12 rounded-2xl border-2 border-dashed border-slate-300 text-slate-400 flex items-center justify-center hover:border-[#3282b8] hover:text-[#3282b8] hover:bg-white transition snap-center mb-4"><i class="fa-solid fa-plus text-lg"></i></button>
                <button @click="deleteLastDay" class="flex-shrink-0 w-12 h-12 rounded-2xl border-2 border-dashed border-red-200 text-red-300 flex items-center justify-center hover:border-red-500 hover:text-red-500 hover:bg-red-50 transition snap-center mr-6 mb-4"><i class="fa-solid fa-trash-can text-lg"></i></button>
            </div>
        </div>
        <div v-show="currentTab !== 'itinerary' && currentTab !== 'map'" class="h-2"></div>
    </div>

    <!-- === TAB 1: FLIGHT (V71 FIXED CENTER) === -->
    <div v-show="currentTab === 'flight'" class="px-6 flex-grow overflow-y-auto pt-4 pb-24">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-slate-700 text-sm flex items-center"><i class="fa-solid fa-ticket text-blue-400 mr-2"></i>Ëà™Áè≠Ë≥áÊñô</h3>
            <button @click="resetFlights" class="text-[10px] text-slate-300 hover:text-red-400 font-bold">ÈáçÁΩÆ</button>
        </div>

        <div v-for="(group, gIdx) in groupedFlights" :key="gIdx" class="mb-8">
            <!-- TICKET CONTAINER -->
            <div class="bg-card-custom rounded-[1.5rem] text-white shadow-xl shadow-blue-900/20 relative overflow-hidden">
                
                <!-- TOP SECTION: FLIGHT 1 -->
                <div class="p-6 pb-12 relative">
                    <!-- Top Header -->
                    <div class="flex items-center justify-between mb-4">
                        <span class="bg-[#3282b8] text-white text-[12px] font-bold px-4 py-1.5 rounded-full">{{ group.type }}</span>
                        <span class="text-[11px] font-bold text-slate-300 font-mono flex items-center gap-2"><i class="fa-regular fa-calendar"></i> {{ group.date }}</span>
                    </div>
                    <!-- Separator Line -->
                    <div class="border-b border-slate-700/50 mb-6"></div>

                    <!-- Flight Code -->
                    <div class="flex justify-center mb-4">
                        <div class="text-[13px] text-[#3282b8] font-bold bg-[#112442] px-4 py-1.5 rounded-lg border border-[#3282b8]/30 shadow-sm tracking-wide">{{ group.f1.code }}</div>
                    </div>

                    <!-- Route Info -->
                    <div class="flex justify-between items-center relative z-10 px-1">
                        <!-- DEP -->
                        <div class="text-center w-28">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">{{ group.f1.depCity }}</div>
                            <div class="text-[42px] font-black tracking-tighter text-white leading-none mb-1">{{ group.f1.depCode }}</div>
                            <div class="text-[13px] font-bold font-mono text-slate-300 tracking-wide">{{ group.f1.depTime }}</div>
                        </div>

                        <!-- ARCH & PLANE -->
                        <div class="flex-grow relative h-20 -mt-6 mx-2">
                            <svg class="w-full h-12 absolute top-0 left-0" viewBox="0 0 100 40" preserveAspectRatio="none" style="overflow: visible;">
                                <path d="M0,40 Q50,0 100,40" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1" stroke-dasharray="4" />
                                <path d="M0,40 Q50,0 100,40" fill="none" stroke="white" stroke-width="1" class="flight-path" />
                            </svg>
                            <!-- PLANE & TIME MOVED LOWER -->
                            <div class="absolute top-[36px] left-0 right-0 flex flex-col items-center justify-center gap-1">
                                <i class="fa-solid fa-plane text-white text-[12px]"></i>
                                <span class="text-[11px] text-slate-400 font-mono">{{ group.f1.duration }}</span>
                            </div>
                        </div>

                        <!-- ARR -->
                        <div class="text-center w-28">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">{{ group.f1.arrCity }}</div>
                            <div class="text-[42px] font-black tracking-tighter text-white leading-none mb-1">{{ group.f1.arrCode }}</div>
                            <div class="text-[13px] font-bold font-mono text-slate-300 tracking-wide">{{ group.f1.arrTime }}</div>
                        </div>
                    </div>
                </div>

                <!-- MIDDLE SECTION: NOTCH & DIVIDER (V71 ADJUSTED) -->
                <div class="relative h-0">
                    <div class="ticket-notch-l"></div>
                    <div class="ticket-notch-r"></div>
                    
                    <!-- SVG Dashed Line (Centered Vertically relative to notches) -->
                    <div class="absolute top-1/2 transform -translate-y-1/2 left-0 w-full h-2 z-10">
                        <svg width="100%" height="100%" preserveAspectRatio="none">
                            <line x1="12" y1="50%" x2="calc(100% - 12px)" y2="50%" stroke="rgba(255,255,255,0.3)" stroke-width="1.5" stroke-dasharray="5,5" />
                        </svg>
                    </div>
                    
                    <!-- Center Badge (Adjusted positioning logic) -->
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-30">
                        <div class="bg-[#112442] px-5 py-1.5 border border-[#3282b8]/40 rounded-full shadow-lg flex items-center gap-2">
                            <i class="fa-solid fa-clock text-[#00b894] text-[10px]"></i>
                            <span class="text-[11px] font-bold text-[#00b894] tracking-wide">ËΩâÊ©ü {{ group.layover }}</span>
                        </div>
                    </div>
                </div>

                <!-- BOTTOM SECTION: FLIGHT 2 -->
                <div class="p-6 pt-10 pb-8 relative bg-[#0B1D35]">
                    
                    <!-- Flight Code -->
                    <div class="flex justify-center mb-4">
                         <div class="text-[13px] text-[#3282b8] font-bold bg-[#112442] px-4 py-1.5 rounded-lg border border-[#3282b8]/30 shadow-sm tracking-wide">{{ group.f2.code }}</div>
                    </div>

                    <!-- Route Info -->
                    <div class="flex justify-between items-center relative z-10 px-1">
                        <!-- DEP -->
                        <div class="text-center w-28">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">{{ group.f2.depCity }}</div>
                            <div class="text-[42px] font-black tracking-tighter text-white leading-none mb-1">{{ group.f2.depCode }}</div>
                            <div class="text-[13px] font-bold font-mono text-slate-300 tracking-wide">{{ group.f2.depTime }}</div>
                        </div>

                        <!-- ARCH & PLANE -->
                        <div class="flex-grow relative h-20 -mt-6 mx-2">
                            <svg class="w-full h-12 absolute top-0 left-0" viewBox="0 0 100 40" preserveAspectRatio="none" style="overflow: visible;">
                                <path d="M0,40 Q50,0 100,40" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1" stroke-dasharray="4" />
                                <path d="M0,40 Q50,0 100,40" fill="none" stroke="white" stroke-width="1" class="flight-path" />
                            </svg>
                             <!-- PLANE & TIME MOVED LOWER -->
                             <div class="absolute top-[36px] left-0 right-0 flex flex-col items-center justify-center gap-1">
                                <i class="fa-solid fa-plane text-white text-[12px]"></i>
                                <span class="text-[11px] text-slate-400 font-mono">{{ group.f2.duration }}</span>
                            </div>
                        </div>

                        <!-- ARR -->
                        <div class="text-center w-28">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">{{ group.f2.arrCity }}</div>
                            <div class="text-[42px] font-black tracking-tighter text-white leading-none mb-1">{{ group.f2.arrCode }}</div>
                            <div class="text-[13px] font-bold font-mono text-slate-300 tracking-wide">{{ group.f2.arrTime }}</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- === TAB 2: ITINERARY === -->
    <div v-show="currentTab === 'itinerary'" class="flex-grow flex flex-col">
        <!-- Inputs -->
        <div class="px-6 py-4">
             <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-3 flex-grow">
                    <div class="w-1.5 h-8 rounded-full bg-aurora"></div> 
                    <input type="text" v-model="safeCurrentItinerary.region" class="font-extrabold text-2xl text-slate-800 bg-transparent border-none outline-none w-full placeholder:text-slate-300 min-w-0" placeholder="Ëº∏ÂÖ•Âú∞ÂçÄ...">
                </div>
                
                <div class="flex items-center gap-2 bg-white p-1.5 rounded-xl border border-slate-100 shadow-sm flex-shrink-0">
                    <input type="text" v-model="safeCurrentItinerary.temp" @blur="formatTemp" placeholder="Temp" class="w-12 text-center text-xs font-bold text-slate-600 outline-none bg-transparent placeholder:text-slate-300">
                    <div class="w-[1px] h-4 bg-slate-200"></div>
                    <div class="relative">
                        <button @click="weatherMenuOpen = !weatherMenuOpen" class="flex items-center gap-1.5 px-2 py-1 rounded-lg hover:bg-slate-50 text-slate-600 transition text-xs font-bold">
                            <i class="fa-solid" :class="[getCurrentWeather.icon, getCurrentWeather.color]"></i>
                            <span>{{ getCurrentWeather.text }}</span>
                        </button>
                        <div v-if="weatherMenuOpen" class="absolute top-10 right-0 bg-white shadow-xl rounded-xl p-2 z-50 border w-28 flex flex-col gap-1">
                            <button v-for="(w, key) in weatherTypes" :key="key" @click="setWeather(key)" class="flex items-center gap-2 px-2 py-2 hover:bg-slate-50 rounded text-xs text-left w-full">
                                <i class="fa-solid w-4 text-center" :class="[w.icon, w.color]"></i> {{ w.text }}
                            </button>
                        </div>
                        <div v-if="weatherMenuOpen" @click="weatherMenuOpen = false" class="fixed inset-0 z-40"></div>
                    </div>
                </div>
             </div>
        </div>

        <!-- Timeline -->
        <div class="flex-grow overflow-y-auto px-6 pb-24">
            <div class="relative min-h-[300px]">
                <div class="absolute left-[15px] top-4 bottom-0 w-[2px] bg-gradient-to-b from-slate-200 to-slate-100"></div>
                
                <div v-for="(item, idx) in currentActivities" :key="item.id" class="relative pl-10 mb-8">
                    <div class="absolute left-[11px] top-[7px] w-[10px] h-[10px] rounded-full border-[2px] border-[#3282b8] bg-white z-10 shadow-sm"></div>
                    
                    <div class="flex justify-between items-baseline mb-2 text-[#0f4c75] font-mono text-sm font-bold">
                        <span>{{ item.time }} <span v-if="item.endTime" class="text-slate-400 text-xs">‚Üí {{ item.endTime }}</span></span>
                        <span v-if="item.distance" class="bg-white px-2 py-0.5 rounded border border-slate-100 text-[10px] text-slate-400 shadow-sm"><i class="fa-solid fa-route mr-1"></i>{{ item.distance }}</span>
                    </div>

                    <div class="bg-white rounded-[1.5rem] shadow-[0_4px_20px_rgb(0,0,0,0.03)] border border-slate-100 overflow-hidden group hover:shadow-lg transition-shadow relative">
                        <div class="relative border-b border-slate-50">
                             <img :src="getCardImage(item)" class="ratio-16-9" loading="lazy" @error="handleImageError">
                             <div class="absolute inset-0 bg-gradient-to-t from-[#0f4c75]/60 to-transparent opacity-80"></div>
                             
                             <!-- EDIT BUTTON -->
                             <button @click="openEditModal(item)" class="absolute top-3 right-3 w-9 h-9 rounded-full bg-white/20 backdrop-blur-none text-white flex items-center justify-center shadow-lg border border-white/30 hover:scale-110 transition"><i class="fa-solid fa-pen text-xs"></i></button>
                        </div>
                        
                        <!-- Card Content -->
                        <div class="p-5 relative pb-14">
                            <h3 class="font-bold text-slate-800 text-lg leading-tight mb-2">{{ item.title }}</h3>
                            <p class="text-xs text-slate-500 line-clamp-2 mb-4 leading-relaxed font-medium">{{ item.desc }}</p>
                            <div class="flex flex-wrap gap-2 pr-16">
                                <span class="text-[10px] px-3 py-1 rounded-full font-bold shadow-sm" :class="getCategoryStyle(item.type).badge">{{ getCategoryStyle(item.type).label }}</span>
                                <!-- Cost Display with Labels -->
                                <span v-for="(c, i) in item.costs" :key="i" class="text-[10px] px-3 py-1 rounded-full bg-slate-50 text-slate-600 border border-slate-200 font-mono">
                                    <span class="font-bold text-slate-400 mr-1">{{ getCostLabel(c) }}:</span>{{ c.currency }} {{ formatMoney(c.amount) }}
                                </span>
                            </div>

                            <!-- NAVIGATION BUTTON: Light Blue Style -->
                            <a v-if="item.lat || item.mapUrl" 
                               :href="item.mapUrl || 'https://www.google.com/maps/search/?api=1&query=' + item.lat + ',' + item.lng" 
                               target="_blank"
                               class="absolute bottom-4 right-4 text-[10px] bg-blue-50 text-blue-600 px-4 py-1.5 rounded-full font-bold shadow-sm flex items-center gap-1.5 hover:bg-blue-100 transition cursor-pointer no-underline z-20">
                               <i class="fa-solid fa-location-arrow text-[9px]"></i> Â∞éËà™
                            </a>
                        </div>
                    </div>
                </div>

                <div v-if="currentActivities.length === 0" class="flex flex-col items-center justify-center py-10 opacity-40">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-300 text-2xl"><i class="fa-solid fa-wind"></i></div>
                    <p class="text-xs text-slate-400 font-bold">ÈªûÊìäÂè≥‰∏ãËßíÊåâÈàïÊñ∞Â¢ûË°åÁ®ã</p>
                </div>
            </div>
        </div>
        
        <button @click="openAddModal" class="fixed bottom-24 right-6 w-14 h-14 bg-aurora text-white rounded-[1.2rem] shadow-xl shadow-blue-500/30 flex items-center justify-center z-30 hover:scale-105 transition"><i class="fa-solid fa-plus text-xl"></i></button>
    </div>

    <!-- === TAB 3: MAP === -->
    <div v-show="currentTab === 'map'" class="px-6 flex-grow flex flex-col h-full pt-2">
        <div class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 mb-3 flex justify-between items-center">
             <span class="text-xs font-bold text-slate-500">È°ØÁ§∫ÁØÑÂúç:</span>
             <select v-model="mapFilter" @change="updateMapLayers" class="bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs outline-none font-bold text-slate-600">
                 <option value="day">ÂÉÖ Day {{ currentDay }}</option>
                 <option value="all">ÊâÄÊúâË°åÁ®ã</option>
             </select>
        </div>
        <div id="map-full" class="bg-slate-200 shadow-inner"></div>
    </div>

    <!-- === TAB 4: HOTEL === -->
    <div v-show="currentTab === 'hotel'" class="px-6 flex-grow overflow-y-auto pt-4">
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-bed text-indigo-400 mr-2"></i>‰ΩèÂÆøË≥áÊñô</h3>
                <button @click="openInfoModal('hotel')" class="text-[10px] bg-indigo-50 text-indigo-500 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-100"><i class="fa-solid fa-plus"></i> Êñ∞Â¢û</button>
            </div>
            <div v-if="infoData.hotels.length === 0" class="text-xs text-slate-400 text-center py-10 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                 <i class="fa-solid fa-hotel text-2xl mb-2 opacity-50"></i><br>Êö´ÁÑ°‰ΩèÂÆøË≥áÊñô
            </div>
            <div v-for="(h, idx) in infoData.hotels" :key="idx" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-3 relative group hover:shadow-md transition">
                <button @click="removeInfo('hotels', idx)" class="absolute top-3 right-3 text-slate-200 hover:text-red-400 transition"><i class="fa-solid fa-xmark"></i></button>
                <div class="flex gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 flex-shrink-0"><i class="fa-solid fa-bed"></i></div>
                    <div class="font-bold text-slate-800 text-base leading-tight pt-1">{{ h.name }}</div>
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-xs text-slate-500"><i class="fa-solid fa-calendar-check mr-1.5 text-indigo-300"></i> {{ h.dates }}</div>
                    <a v-if="h.link" :href="h.link" target="_blank" class="text-[10px] text-white bg-indigo-400 px-2 py-1 rounded hover:bg-indigo-500 transition font-bold"><i class="fa-solid fa-link"></i> Ë®ÇÂñÆ</a>
                </div>
            </div>
        </div>
    </div>

    <!-- === TAB 5: COST === -->
    <div v-show="currentTab === 'budget'" class="px-6 flex-grow overflow-y-auto pt-4">
        <div class="bg-gradient-to-br from-[#0f4c75] to-[#3282b8] rounded-[1.5rem] p-6 text-white shadow-xl shadow-blue-900/20 mb-6 text-center relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
            <div class="text-[10px] font-bold opacity-80 mb-2 uppercase tracking-widest">Á∏ΩÈ†ê‰º∞Ëä±Ë≤ª</div>
            <div class="text-4xl font-bold font-mono tracking-tight text-white drop-shadow-sm"><span class="text-2xl align-top opacity-70 mr-1">HK$</span>{{ formatMoney(totalTripCostHKD) }}</div>
            <div @click="rateModal.open=true" class="mt-4 inline-flex items-center gap-2 bg-black/20 px-3 py-1.5 rounded-lg text-[10px] font-bold cursor-pointer hover:bg-black/30 transition border border-white/10">
                <span>ÂåØÁéá: 1 ISK ‚âà {{ exchangeRate }} HKD</span> <i class="fa-solid fa-pen"></i>
            </div>
        </div>

        <h3 class="font-bold text-slate-700 mb-4 text-sm px-1">ÊØèÊó•Ëä±Ë≤ªÁµ±Ë®à</h3>
        <div class="space-y-4 pb-8">
            <div v-for="d in dailyCosts" :key="d.day" class="flex items-center gap-3">
                <div class="w-14 text-[10px] font-bold text-slate-400 whitespace-nowrap">Day {{ d.day }}</div>
                <div class="flex-grow h-2.5 bg-slate-100 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-blue-400 to-indigo-400 rounded-full transition-all duration-500" :style="{ width: d.percent + '%' }"></div>
                </div>
                <div class="w-20 text-right text-xs font-mono font-bold text-slate-600">HK$ {{ formatMoney(d.amount) }}</div>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION (FIXED V70) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 pb-4 pt-2 px-1 flex justify-between z-50 h-[80px]">
        <button @click="switchTab('flight')" class="flex-1 flex flex-col items-center gap-1.5 transition-colors group" :class="currentTab === 'flight' ? 'tab-active' : 'tab-inactive'">
            <div class="text-xl"><i class="fa-solid fa-plane"></i></div>
            <span class="text-[9px] font-bold tracking-wide">Ëà™Áè≠</span>
        </button>
        <button @click="switchTab('itinerary')" class="flex-1 flex flex-col items-center gap-1.5 transition-colors group" :class="currentTab === 'itinerary' ? 'tab-active' : 'tab-inactive'">
            <div class="text-xl"><i class="fa-solid fa-list-ul"></i></div>
            <span class="text-[9px] font-bold tracking-wide">Ë°åÁ®ã</span>
        </button>
        <button @click="switchTab('map')" class="flex-1 flex flex-col items-center gap-1.5 transition-colors group" :class="currentTab === 'map' ? 'tab-active' : 'tab-inactive'">
            <div class="text-xl"><i class="fa-solid fa-map"></i></div>
            <span class="text-[9px] font-bold tracking-wide">Âú∞Âúñ</span>
        </button>
        <button @click="switchTab('hotel')" class="flex-1 flex flex-col items-center gap-1.5 transition-colors group" :class="currentTab === 'hotel' ? 'tab-active' : 'tab-inactive'">
            <div class="text-xl"><i class="fa-solid fa-bed"></i></div>
            <span class="text-[9px] font-bold tracking-wide">‰ΩèÂÆø</span>
        </button>
        <button @click="switchTab('budget')" class="flex-1 flex flex-col items-center gap-1.5 transition-colors group" :class="currentTab === 'budget' ? 'tab-active' : 'tab-inactive'">
            <div class="text-xl"><i class="fa-solid fa-wallet"></i></div>
            <span class="text-[9px] font-bold tracking-wide">Ëä±Ë≤ª</span>
        </button>
    </div>

    <!-- MODAL: ADD INFO (UPDATED FOR HOTEL ONLY) -->
    <div v-if="infoModal.open" class="fixed inset-0 z-[100] flex items-center justify-center p-6">
        <div class="absolute inset-0 modal-overlay" @click="infoModal.open=false"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl space-y-4 animate-slide-up">
             <h3 class="font-bold text-xl text-slate-800">Êñ∞Â¢û‰ΩèÂÆø</h3>
             <input v-model="infoForm.name" class="modal-input" placeholder="‰ΩèÂÆøÂêçÁ®±">
             <input v-model="infoForm.dates" class="modal-input" placeholder="ÂÖ•‰ΩèÊó•Êúü">
             <input v-model="infoForm.link" class="modal-input" placeholder="Ë®ÇÂñÆÈÄ£Áµê (ÈÅ∏Â°´)">
             <div class="flex gap-3 mt-4"><button @click="infoModal.open=false" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500">ÂèñÊ∂à</button><button @click="saveInfo" class="flex-1 py-3 bg-[#3282b8] text-white rounded-xl font-bold shadow-lg shadow-blue-500/20">Êñ∞Â¢û</button></div>
        </div>
    </div>

    <!-- MODAL: RATE -->
    <div v-if="rateModal.open" class="fixed inset-0 z-[100] flex items-center justify-center p-6">
        <div class="absolute inset-0 modal-overlay" @click="rateModal.open=false"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] p-8 text-center shadow-2xl animate-slide-up">
             <h3 class="font-bold text-xl text-slate-800 mb-6">Ë®≠ÂÆöÂåØÁéá</h3>
             <div class="relative mb-8">
                <input type="number" v-model="exchangeRate" class="text-4xl text-center border-b-2 border-slate-100 w-full pb-2 font-mono text-slate-700 focus:outline-none focus:border-blue-400" step="0.001">
                <div class="text-xs text-slate-400 mt-2">1 ISK = HKD</div>
             </div>
             <button @click="rateModal.open=false" class="w-full py-3.5 bg-[#3282b8] text-white rounded-xl font-bold shadow-lg shadow-blue-500/20">Á¢∫Ë™çË®≠ÂÆö</button>
        </div>
    </div>

    <!-- MODAL: SHARE -->
    <div v-if="shareModal.open" class="fixed inset-0 z-[100] flex items-center justify-center p-6">
        <div class="absolute inset-0 modal-overlay" @click="shareModal.open=false"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] p-8 text-center space-y-4 animate-slide-up">
             <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto text-2xl mb-2"><i class="fa-solid fa-share-nodes"></i></div>
             <h3 class="font-bold text-xl text-slate-800">Ë°åÁ®ãÂàÜ‰∫´</h3>
             <button @click="copyData" class="w-full py-3.5 bg-[#3282b8] text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition">Ë§áË£ΩË°åÁ®ã‰ª£Á¢º</button>
             <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-100"></div></div><div class="relative"><span class="bg-white px-2 text-xs text-slate-400">OR</span></div></div>
             <textarea v-model="shareModal.importData" class="w-full border p-3 rounded-xl text-xs bg-slate-50 focus:bg-white transition resize-none font-mono" rows="4" placeholder="Âú®Ê≠§Ë≤º‰∏ä‰ª£Á¢º‰ª•ÂåØÂÖ•..."></textarea>
             <div class="flex gap-3"><button @click="shareModal.open=false" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500">ÈóúÈñâ</button><button @click="importData" class="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold">ÂåØÂÖ•</button></div>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT ACTIVITY (Moved down to ensure it doesn't break flow) -->
    <div v-if="modal.open" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="absolute inset-0 modal-overlay transition-opacity" @click="modal.open=false"></div>
        <div class="relative bg-white w-full max-w-sm rounded-t-[2rem] sm:rounded-[2rem] p-6 pb-10 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
            <!-- Modal content ... (same as before) -->
             <div class="flex justify-between items-center mb-6">
                <h3 class="font-extrabold text-xl text-slate-800">{{ modal.mode==='add'?'Êñ∞Â¢û':'Á∑®ËºØ' }}Ë°åÁ®ã</h3>
                <button @click="modal.open=false" class="w-8 h-8 bg-slate-50 rounded-full text-slate-400 hover:bg-slate-100"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="space-y-5">
                <div class="flex gap-4">
                    <div class="w-1/2"><label class="text-xs font-bold text-slate-400 mb-1.5 block">ÊôÇÈñì</label><input type="time" v-model="form.time" class="modal-input"></div>
                    <div class="w-1/2"><label class="text-xs font-bold text-slate-400 mb-1.5 block">ÊäµÈÅî(ÈÅ∏Â°´)</label><input type="time" v-model="form.endTime" class="modal-input"></div>
                </div>
                <div class="flex gap-4">
                    <div class="w-1/2"><label class="text-xs font-bold text-slate-400 mb-1.5 block">Á®ÆÈ°û</label>
                    <select v-model="form.type" class="modal-input">
                        <option v-for="(v,k) in categoryConfig" :value="k">{{v.emoji}} {{v.label}}</option>
                    </select>
                    </div>
                    <div class="w-1/2"><label class="text-xs font-bold text-slate-400 mb-1.5 block">Ë∑ùÈõ¢</label><input v-model="form.distance" class="modal-input"></div>
                </div>
                <div><label class="text-xs font-bold text-[#3282b8] mb-1.5 block">1. ÂúñÁâáÁ∂≤ÂùÄ</label><input v-model="form.imgUrl" class="modal-input text-xs" placeholder="ÁïôÁ©∫Â∞áÁî± AI Ëá™ÂãïÁî¢Áîü"></div>
                <div><label class="text-xs font-bold text-[#3282b8] mb-1.5 block">2. Ê®ôÈ°å</label><input v-model="form.title" class="modal-input text-lg placeholder:text-slate-300" placeholder="‰æãÂ¶Ç: Sk√≥gafoss"></div>
                
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-2">
                     <label class="text-xs font-bold text-[#3282b8] block">3. Âú∞Èªû & ÂÆö‰Ωç</label>
                     <div class="flex gap-2">
                        <input v-model="form.location" class="modal-input bg-white" placeholder="Ëº∏ÂÖ•Âú∞ÈªûÂêçÁ®±ÊêúÂ∞ã">
                        <button @click="autoLocate" class="w-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center transition active:scale-95"><i class="fa-solid" :class="locating?'fa-spinner fa-spin':'fa-map-location-dot'"></i></button>
                     </div>
                     <div class="flex gap-2 text-[10px] items-center">
                        <input type="number" v-model.number="form.lat" class="border p-1.5 rounded-lg w-20 text-center" placeholder="Lat">
                        <input type="number" v-model.number="form.lng" class="border p-1.5 rounded-lg w-20 text-center" placeholder="Lng">
                        <span v-if="form.lat" class="text-green-600 font-bold ml-auto flex items-center gap-1"><i class="fa-solid fa-check-circle"></i> Â∑≤ÂÆö‰Ωç</span>
                     </div>
                     <input v-model="form.mapUrl" class="modal-input bg-white text-xs text-blue-500" placeholder="Google Maps ÈÄ£Áµê (ÈÅ∏Â°´)">
                </div>

                <div class="bg-blue-50/30 p-4 rounded-2xl border border-blue-100/50">
                     <div class="flex justify-between mb-2 items-center"><label class="text-xs font-bold text-[#3282b8]">4. Áõ∏ÈóúË≤ªÁî®</label><button @click="addCost" class="text-[10px] bg-white border border-blue-200 text-blue-500 px-2 py-1 rounded-lg font-bold hover:bg-blue-50"><i class="fa-solid fa-plus"></i> Êñ∞Â¢û</button></div>
                     <div v-for="(c,i) in form.costs" :key="i" class="flex flex-col gap-1.5 mb-2 bg-white p-2.5 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex gap-2 items-center">
                            <select v-model="c.type" class="bg-slate-50 text-xs w-[35%] border-none rounded-lg py-1.5 font-bold text-slate-600"><option v-for="(v,k) in costTypes" :value="k">{{v.label}}</option></select>
                            <button @click="c.currency = c.currency==='ISK'?'HK$':'ISK'" class="text-[10px] w-[15%] border rounded-lg py-1.5 font-bold transition-colors" :class="c.currency==='HK$'?'text-red-500 bg-red-50 border-red-100':'text-blue-500 bg-blue-50 border-blue-100'">{{c.currency}}</button>
                            <input v-model="c.amount" @blur="formatCostInput(c)" class="text-xs w-[40%] bg-slate-50 border-none rounded-lg px-2 py-1.5 text-right font-mono font-bold" placeholder="0">
                            <button @click="form.costs.splice(i,1)" class="text-slate-300 hover:text-red-400 w-[10%]"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <input v-if="c.type==='other'" v-model="c.name" class="text-xs border border-slate-100 bg-slate-50 rounded-lg px-2 py-1.5 w-full" placeholder="Ë≤ªÁî®ÂêçÁ®±">
                     </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2 items-center"><label class="text-xs font-bold text-[#3282b8]">5. ÂÇôË®ª</label><button @click="autoGenerateDesc" class="text-[10px] bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold shadow-sm hover:bg-purple-200 transition"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Êí∞ÂØ´</button></div>
                    <textarea v-model="form.desc" class="modal-input leading-relaxed" rows="3" placeholder="Ëº∏ÂÖ•Ë°åÁ®ãÂÇôË®ª..."></textarea>
                </div>
            </div>
            <div class="mt-8 flex gap-4">
                <button v-if="modal.mode==='edit'" @click="deleteItem" class="p-4 bg-red-50 text-red-400 rounded-2xl hover:bg-red-100 transition"><i class="fa-solid fa-trash-can text-lg"></i></button>
                <button @click="saveItem" class="flex-1 bg-aurora text-white rounded-2xl py-4 font-bold text-lg shadow-xl shadow-blue-500/20 active:scale-95 transition">ÂÑ≤Â≠òÁ¢∫Ë™ç</button>
            </div>
        </div>
    </div>

</div>

<script>
// ... (Script remains the same as V70)
const { createApp, ref, computed, reactive, watch, nextTick } = Vue;

const categoryConfig = { flight: { label: 'Ëà™Áè≠', emoji: '‚úàÔ∏è', badge: 'bg-blue-500 text-white' }, car: { label: 'Ëá™Èßï', emoji: 'üöô', badge: 'bg-slate-700 text-white' }, hotel: { label: '‰ΩèÂÆø', emoji: 'üè®', badge: 'bg-indigo-500 text-white' }, food: { label: 'ÁæéÈ£ü', emoji: 'üçΩÔ∏è', badge: 'bg-orange-400 text-white' }, camera: { label: 'ÊôØÈªû', emoji: 'üì∏', badge: 'bg-[#00b894] text-white' }, tour: { label: 'Ê¥ªÂãï', emoji: 'üé´', badge: 'bg-[#0984e3] text-white' }, shop: { label: 'Ë≥ºÁâ©', emoji: 'üõçÔ∏è', badge: 'bg-pink-400 text-white' }, other: { label: 'ÂÖ∂‰ªñ', emoji: 'üìå', badge: 'bg-slate-400 text-white' } };
const costTypes = { parking: { label: 'ÂÅúËªäË≤ª' }, toll: { label: 'Ë∑ØË≤ª' }, ticket: { label: 'ÂÖ•Â†¥Ë≤ª' }, stay: { label: '‰ΩèÂÆøË≤ª' }, food: { label: 'È§êÈ£≤' }, gas: { label: 'Âä†Ê≤πË≤ª' }, other: { label: 'ÂÖ∂‰ªñ' } };
const weatherTypes = { sunny: { text: 'Êô¥Êúó', icon: 'fa-sun', color: 'text-amber-400' }, cloudy: { text: 'Â§öÈõ≤', icon: 'fa-cloud', color: 'text-slate-400' }, snow: { text: '‰∏ãÈõ™', icon: 'fa-snowflake', color: 'text-blue-300' }, windy: { text: 'Âº∑È¢®', icon: 'fa-wind', color: 'text-slate-500' }, rain: { text: 'Èô£Èõ®', icon: 'fa-cloud-showers-heavy', color: 'text-blue-500' } };

// PREDEFINED FLIGHTS (HARDCODED FOR USER)
const PRESET_FLIGHTS = [
    { type: 'ÂéªÁ®ã', date: '2026-03-22 (SUN)', nextDate: '2026-03-23 (MON)',
      f1: { code: 'AY100', depCity: 'HONG KONG', depCode: 'HKG', depTime: '21:45', arrCity: 'HELSINKI', arrCode: 'HEL', arrTime: '05:45', duration: '14h' },
      layover: '1hr 35m',
      f2: { code: 'AY991', depCity: 'HELSINKI', depCode: 'HEL', depTime: '07:20', arrCity: 'REYKJAVIK', arrCode: 'KEF', arrTime: '09:15', duration: '3h 55m' }
    },
    { type: 'ÂõûÁ®ã', date: '2026-04-05 (SUN)', nextDate: '2026-04-06 (MON)',
      f1: { code: 'AY994', depCity: 'REYKJAVIK', depCode: 'KEF', depTime: '17:10', arrCity: 'HELSINKI', arrCode: 'HEL', arrTime: '23:35', duration: '3h 25m' },
      layover: '1hr',
      f2: { code: 'AY099', depCity: 'HELSINKI', depCode: 'HEL', depTime: '00:35', arrCity: 'HONG KONG', arrCode: 'HKG', arrTime: '17:40', duration: '12h 05m' }
    }
];

createApp({
    setup() {
        // --- STATE ---
        const currentTab = ref('flight'); // Default to Flight
        const currentDay = ref(1);
        const totalDays = ref(15);
        const itineraryData = ref({});
        const infoData = ref({ hotels: [] }); // No flight array in LS needed for hardcoded view, but kept structure safe
        const exchangeRate = ref(0.056);
        const mapFilter = ref('day');
        
        // --- UI State ---
        const weatherMenuOpen = ref(false);
        const locating = ref(false);
        const modal = reactive({ open: false, mode: 'add' });
        const infoModal = reactive({ open: false, type: 'hotel' });
        const rateModal = reactive({ open: false });
        const shareModal = reactive({ open: false, importData: '' });
        
        // --- Forms ---
        const form = reactive({ id: null, time: '', endTime: '', type: 'camera', title: '', distance: '', location: '', lat: null, lng: null, mapUrl: '', imgUrl: '', costs: [], desc: '' });
        const infoForm = reactive({ name: '', dates: '', link: '' });

        // --- Map Vars ---
        let mapInstance = null;
        let markers = [];
        let routeLine = null;

        const startDate = new Date('2026-03-22');
        const daysOfWeek = ['(Êó•)', '(‰∏Ä)', '(‰∫å)', '(‰∏â)', '(Âõõ)', '(‰∫î)', '(ÂÖ≠)'];

        // --- INIT ---
        const init = () => {
            const d = localStorage.getItem('iceland_v71_data') || localStorage.getItem('iceland_v70_data') || localStorage.getItem('iceland_v69_data') || localStorage.getItem('iceland_v68_data') || localStorage.getItem('iceland_v67_data') || localStorage.getItem('iceland_v66_data') || localStorage.getItem('iceland_v65_data') || localStorage.getItem('iceland_v64_data') || localStorage.getItem('iceland_v63_data') || localStorage.getItem('iceland_v62_data') || localStorage.getItem('iceland_v61_data');
            const i = localStorage.getItem('iceland_v71_info') || localStorage.getItem('iceland_v70_info') || localStorage.getItem('iceland_v69_info') || localStorage.getItem('iceland_v68_info') || localStorage.getItem('iceland_v67_info') || localStorage.getItem('iceland_v66_info') || localStorage.getItem('iceland_v65_info') || localStorage.getItem('iceland_v64_info') || localStorage.getItem('iceland_v63_info') || localStorage.getItem('iceland_v62_info') || localStorage.getItem('iceland_v61_info');
            const r = localStorage.getItem('iceland_rate');
            
            // Default Init if null
            let data = d ? JSON.parse(d) : {};
            
            const dayKeys = Object.keys(data).map(Number);
            const maxDay = dayKeys.length > 0 ? Math.max(...dayKeys) : 15;
            totalDays.value = Math.max(maxDay, 15);

            for(let k=1; k<=totalDays.value; k++) {
                if(!data[k]) {
                    data[k] = { date: `DAY ${k}`, region: "", weather: "sunny", temp: "", activities: [] };
                }
                if(!data[k].activities) data[k].activities = [];
                if(!data[k].temp) data[k].temp = "";
                
                data[k].activities.forEach(a => {
                    if(!a.costs) a.costs = [];
                    a.costs.forEach(c => { if(!c.currency) c.currency = 'ISK'; });
                });
            }
            itineraryData.value = data;
            infoData.value = i ? JSON.parse(i) : { hotels: [] };
            if(r) exchangeRate.value = parseFloat(r);
        };
        init();

        // --- WATCHERS ---
        watch([itineraryData, infoData, exchangeRate, totalDays], () => {
            localStorage.setItem('iceland_v71_data', JSON.stringify(itineraryData.value));
            localStorage.setItem('iceland_v71_info', JSON.stringify(infoData.value));
            localStorage.setItem('iceland_rate', exchangeRate.value);
        }, { deep: true });

        // --- COMPUTED ---
        const safeCurrentItinerary = computed(() => {
            if(!itineraryData.value[currentDay.value]) {
                itineraryData.value[currentDay.value] = { date: `DAY ${currentDay.value}`, region: "", weather: "sunny", temp: "", activities: [] };
            }
            return itineraryData.value[currentDay.value];
        });
        
        const currentActivities = computed(() => (safeCurrentItinerary.value.activities || []).sort((a, b) => a.time.localeCompare(b.time)));
        const getCurrentWeather = computed(() => weatherTypes[safeCurrentItinerary.value.weather || 'sunny'] || weatherTypes.sunny);
        const groupedFlights = computed(() => PRESET_FLIGHTS); // Using Hardcoded Data
        
        const totalTripCostHKD = computed(() => {
            let total = 0;
            Object.values(itineraryData.value).forEach(d => {
                if(d.activities) d.activities.forEach(a => a.costs.forEach(c => {
                    const amt = parseMoney(c.amount);
                    total += (c.currency === 'HK$' ? amt : amt * exchangeRate.value);
                }));
            });
            return Math.round(total);
        });

        const dailyCosts = computed(() => {
            const res = [];
            let max = 0;
            for(let i=1; i<=totalDays.value; i++) {
                let sum = 0;
                if(itineraryData.value[i]?.activities) {
                    itineraryData.value[i].activities.forEach(a => a.costs.forEach(c => {
                        sum += (c.currency === 'HK$' ? parseMoney(c.amount) : parseMoney(c.amount) * exchangeRate.value);
                    }));
                }
                if(sum > max) max = sum;
                res.push({ day: i, amount: Math.round(sum), percent: 0 });
            }
            res.forEach(r => r.percent = max > 0 ? (r.amount / max * 100) : 0);
            return res;
        });

        const getDateString = (d) => {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + (d - 1));
            return { date: `${date.getMonth()+1}/${date.getDate()}`, day: daysOfWeek[date.getDay()] };
        };

        const formatMoney = (val) => {
            if (!val && val !== 0) return '0';
            return parseFloat(String(val).replace(/,/g, '')).toLocaleString('en-US');
        };
        const parseMoney = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
        const formatCostInput = (c) => { c.amount = formatMoney(c.amount); };
        
        const formatTemp = () => {
            let val = safeCurrentItinerary.value.temp;
            if(val && !isNaN(parseFloat(val)) && !val.includes('¬∞C')) {
                safeCurrentItinerary.value.temp = val + '¬∞C';
            }
        };

        const getCostLabel = (c) => {
            if(c.type === 'other' && c.name) return c.name;
            return costTypes[c.type] ? costTypes[c.type].label : 'Ë≤ªÁî®';
        };

        // Map Logic
        const initMap = () => {
            const el = document.getElementById('map-full');
            if(!el) return;
            if(!mapInstance) {
                mapInstance = L.map('map-full', { zoomControl: false }).setView([64.9631, -19.0208], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
            }
            setTimeout(() => { mapInstance.invalidateSize(); updateMapLayers(); }, 100);
        };

        const updateMapLayers = () => {
            if(!mapInstance) return;
            markers.forEach(m => mapInstance.removeLayer(m)); markers = [];
            if(routeLine) mapInstance.removeLayer(routeLine);

            let list = [];
            if(mapFilter.value === 'day') list = currentActivities.value;
            else {
                Object.values(itineraryData.value).forEach(d => { if(d.activities) list.push(...d.activities); });
            }

            const points = [];
            list.forEach(item => {
                if(item.lat && item.lng) {
                    const m = L.marker([item.lat, item.lng]).addTo(mapInstance);
                    m.bindPopup(`<b>${item.title}</b><br>${item.time}`);
                    markers.push(m);
                    points.push([item.lat, item.lng]);
                }
            });

            if(points.length > 0) {
                if(mapFilter.value === 'day' && points.length > 1) {
                    routeLine = L.polyline(points, { color: '#3282b8', weight: 3 }).addTo(mapInstance);
                }
                const group = new L.featureGroup(markers);
                mapInstance.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        };

        const switchTab = (t) => {
            currentTab.value = t;
            if(t === 'map') nextTick(initMap);
        };

        watch(currentDay, () => { if(currentTab.value === 'map') nextTick(updateMapLayers); });

        const addDay = () => { 
            totalDays.value++; 
            itineraryData.value[totalDays.value] = { date: `DAY ${totalDays.value}`, region: "Âú∞Èªû", weather: "sunny", temp: "", activities: [] }; 
        };
        const deleteLastDay = () => { if(totalDays.value>1 && confirm('Âà™Èô§ÊúÄÂæå‰∏ÄÂ§©?')) { delete itineraryData.value[totalDays.value]; totalDays.value--; } };
        
        // Modal Logic
        const openAddModal = () => {
            if(!itineraryData.value[currentDay.value]) {
                itineraryData.value[currentDay.value] = { date: `DAY ${currentDay.value}`, region: "", weather: "sunny", temp: "", activities: [] };
            }
            modal.mode = 'add';
            Object.assign(form, { id: Date.now(), time: '09:00', endTime: '', type: 'camera', title: '', distance: '', location: '', lat: null, lng: null, mapUrl: '', imgUrl: '', costs: [], desc: '' });
            modal.open = true;
        };
        const openEditModal = (item) => {
            modal.mode = 'edit';
            Object.assign(form, JSON.parse(JSON.stringify(item)));
            if(!form.costs) form.costs = [];
            form.costs.forEach(c => c.amount = formatMoney(c.amount));
            modal.open = true;
        };
        const addCost = () => form.costs.push({ type: 'ticket', amount: '', currency: 'ISK', name: '' });
        
        const saveItem = () => {
            if (!itineraryData.value[currentDay.value]) itineraryData.value[currentDay.value] = { date: `DAY ${currentDay.value}`, region: "", weather: "sunny", temp: "", activities: [] };
            if (!itineraryData.value[currentDay.value].activities) itineraryData.value[currentDay.value].activities = [];

            const acts = itineraryData.value[currentDay.value].activities;
            const data = JSON.parse(JSON.stringify(form));
            data.costs.forEach(c => c.amount = formatMoney(c.amount));

            if(modal.mode === 'add') acts.push(data);
            else { 
                const idx = acts.findIndex(i => i.id === form.id); 
                if(idx !== -1) acts[idx] = data; 
            }
            modal.open = false;
        };
        
        const deleteItem = () => {
            if(confirm('Á¢∫ÂÆöÂà™Èô§?')) {
                const acts = itineraryData.value[currentDay.value].activities;
                const idx = acts.findIndex(i => i.id === form.id);
                if(idx !== -1) acts.splice(idx, 1);
                modal.open = false;
            }
        };

        const openInfoModal = (type) => {
            infoModal.type = type;
            Object.assign(infoForm, { name: '', dates: '', link: '' });
            infoModal.open = true;
        };
        const saveInfo = () => {
            if(infoModal.type === 'hotel') infoData.value.hotels.push({ ...infoForm });
            infoModal.open = false;
        };
        const removeInfo = (list, idx) => { if(confirm('Âà™Èô§?')) infoData.value[list].splice(idx, 1); };

        const autoLocate = async () => {
            if(!form.location) return alert("Ë´ãËº∏ÂÖ•Âú∞Èªû");
            locating.value = true;
            try {
                const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(form.location + " Iceland") + '&limit=1');
                const data = await res.json();
                if(data.length) { 
                    form.lat = parseFloat(data[0].lat); 
                    form.lng = parseFloat(data[0].lon); 
                    form.mapUrl = 'https://www.google.com/maps/search/?api=1&query=' + form.lat + ',' + form.lng;
                }
                else alert("Êâæ‰∏çÂà∞Âú∞Èªû");
            } catch(e) { alert("ÂÆö‰ΩçÈåØË™§"); }
            locating.value = false;
        };
        const autoGenerateDesc = () => {
            const t = form.title || '';
            if(t.includes('ÁÄëÂ∏É')) form.desc = 'Â£ØËßÄÁÄëÂ∏ÉÔºåÊ≥®ÊÑèÈò≤Ê∞¥„ÄÇ';
            else if(t.includes('Ë∂ÖÂ∏Ç')) form.desc = 'Ë£úÁµ¶ÊôÇÈñìÔºåBonus ÊúÄÂπ≥„ÄÇ';
            else form.desc = 'ÂâçÂæÄ ' + t + ' Êé¢Á¥¢ÁæéÊôØ„ÄÇ';
        };
        const copyData = () => {
            const d = JSON.stringify({ data: itineraryData.value, info: infoData.value, rate: exchangeRate.value });
            navigator.clipboard.writeText(d).then(() => alert("Â∑≤Ë§áË£Ω"));
        };
        const importData = () => {
            try {
                const p = JSON.parse(shareModal.importData);
                if(p.data) {
                    itineraryData.value = p.data;
                    if(p.info) infoData.value = p.info;
                    if(p.rate) exchangeRate.value = p.rate;
                    totalDays.value = Math.max(...Object.keys(p.data).map(Number), 15);
                    alert("ÂåØÂÖ•ÊàêÂäü"); shareModal.open = false;
                }
            } catch(e) { alert("‰ª£Á¢ºÈåØË™§"); }
        };

        const getCardImage = (item) => item.imgUrl || 'https://image.pollinations.ai/prompt/' + encodeURIComponent((item.title||'Iceland')+' travel') + '?width=400&height=225&nologo=true';
        const handleImageError = (e) => e.target.src = 'https://picsum.photos/seed/' + Math.random() + '/400/225?grayscale';
        const getCategoryStyle = (t) => categoryConfig[t] || categoryConfig.other;
        const setWeather = (k) => { itineraryData.value[currentDay.value].weather = k; weatherMenuOpen.value = false; };
        
        // Stub for reset (Since data is hardcoded now, this just refreshes page)
        const resetFlights = () => location.reload();

        return {
            currentTab, currentDay, totalDays, itineraryData, infoData, exchangeRate, mapFilter,
            modal, infoModal, rateModal, shareModal, form, infoForm, weatherMenuOpen, locating,
            categoryConfig, costTypes, weatherTypes,
            switchTab, getDateString, addDay, deleteLastDay,
            safeCurrentItinerary, currentActivities, getCurrentWeather, setWeather,
            getCardImage, handleImageError, getCategoryStyle, formatMoney,
            openAddModal, openEditModal, saveItem, deleteItem, addCost, formatCostInput,
            openInfoModal, saveInfo, removeInfo,
            autoLocate, autoGenerateDesc, copyData, importData,
            totalTripCostHKD, dailyCosts, formatTemp,
            getCostLabel, groupedFlights, resetFlights
        };
    }
}).mount('#app');
</script>
</body>
</html>
